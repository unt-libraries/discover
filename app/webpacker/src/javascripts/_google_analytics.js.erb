import 'autotrack/lib/plugins/event-tracker';
import 'autotrack/lib/plugins/max-scroll-tracker';
import 'autotrack/lib/plugins/page-visibility-tracker';
import 'autotrack/lib/plugins/outbound-link-tracker';


function init() {
  // Additional google analytics code
  window.ga = window.ga || ((...args) => (ga.q = ga.q || []).push(args));

  ga('create', '<%= Rails.application.credentials[Rails.env.to_sym][:google_analytics] %>', 'auto');
  ga('require', 'eventTracker');
  ga('require', 'maxScrollTracker');
  ga('require', 'pageVisibilityTracker', {
    sendInitialPageview: true,
  });
  ga('require', 'outboundLinkTracker', {
    fieldsObj: {
      eventCategory: "link - content - external",
      eventAction: `${window.location.pathname}${window.location.search}`,
    }
  });
  ga('set', 'anonymizeIp', true);
  ga('set', 'transport', 'beacon');
  console.log('analytics loaded');
}

// Report javascript errors
function trackErrors() {
  if (window.addEventListener) {
    window.addEventListener('error', (e) => {
      if (e.lineno !== 0) {
        const ie = window.event || {};
        const errMsg = e.message || ie.errorMessage;
        const errSrc = e.filename || ie.errorUrl;
        const errLine = e.lineno || ie.errorLine;
        const gaCat = 'JavaScript Error';
        const gaAction = `${errMsg} in: ${errSrc} on line ${errLine}`;
        const bodyEl = document.querySelector('body');
        const gaLabel = bodyEl.dataset.blacklightContext;
        const url = document.location.href;

        ga('send', 'event', gaCat, gaAction, `${gaLabel} - ${url}`, {
          nonInteraction: true,
        });
      }
    });
  }
}

export {
  init,
  trackErrors,
}
